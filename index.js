// ============================================
// IMPORTS
// ============================================
const express = require('express');
const cors = require('cors');
const axios = require('axios');
const { Client, GatewayIntentBits, EmbedBuilder, ChannelType } = require('discord.js');
require('dotenv').config();

// ============================================
// KONFIGURACJA
// ============================================
const app = express();
const PORT = process.env.PORT || 3000;

// Discord Bot Client
const client = new Client({
    intents: [
        GatewayIntentBits.Guilds,
        GatewayIntentBits.GuildMessages,
        GatewayIntentBits.MessageContent
    ]
});

// ============================================
// MIDDLEWARE
// ============================================
app.use(cors({
    origin: process.env.FRONTEND_URL || '*',
    credentials: true
}));
app.use(express.json());

// Logowanie request√≥w
app.use((req, res, next) => {
    console.log(`${new Date().toISOString()} - ${req.method} ${req.path}`);
    next();
});

// ============================================
// BOT EVENTS
// ============================================
client.once('ready', () => {
    console.log('‚úÖ Bot Discord zalogowany!');
    console.log(`üìõ Zalogowany jako: ${client.user.tag}`);
    console.log(`üåê Na ${client.guilds.cache.size} serwerach`);
    console.log('================================');
    
    // Wy≈õwietl serwery na kt√≥rych jest bot
    client.guilds.cache.forEach(guild => {
        console.log(`   - ${guild.name} (ID: ${guild.id})`);
    });
    console.log('================================');
});

client.on('error', error => {
    console.error('‚ùå B≈ÇƒÖd Discord bota:', error);
});

// Logowanie gdy bot do≈ÇƒÖcza do serwera
client.on('guildCreate', guild => {
    console.log(`‚úÖ Bot do≈ÇƒÖczy≈Ç do nowego serwera: ${guild.name}`);
});

// ============================================
// API ROUTES
// ============================================

// Health check
app.get('/', (req, res) => {
    res.json({ 
        status: 'online',
        bot: client.user ? {
            username: client.user.tag,
            id: client.user.id,
            servers: client.guilds.cache.size
        } : 'offline',
        version: '1.0.0'
    });
});

// ============================================
// OAUTH2 - Wymiana kodu na token
// ============================================
app.post('/auth/token', async (req, res) => {
    const { code } = req.body;
    
    if (!code) {
        return res.status(400).json({ 
            error: 'Brak kodu autoryzacyjnego' 
        });
    }
    
    try {
        console.log('üîê Wymiana kodu OAuth2 na token...');
        
        const response = await axios.post(
            'https://discord.com/api/oauth2/token',
            new URLSearchParams({
                client_id: process.env.CLIENT_ID,
                client_secret: process.env.CLIENT_SECRET,
                grant_type: 'authorization_code',
                code: code,
                redirect_uri: process.env.REDIRECT_URI
            }),
            {
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            }
        );
        
        console.log('‚úÖ Token otrzymany pomy≈õlnie');
        res.json(response.data);
        
    } catch (error) {
        console.error('‚ùå B≈ÇƒÖd wymiany tokenu:', error.response?.data || error.message);
        res.status(500).json({ 
            error: 'B≈ÇƒÖd autoryzacji Discord',
            details: error.response?.data || error.message
        });
    }
});

// ============================================
// Pobierz serwery u≈ºytkownika
// ============================================
app.get('/guilds', async (req, res) => {
    const authHeader = req.headers.authorization;
    
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
        return res.status(401).json({ 
            error: 'Brak tokenu autoryzacyjnego' 
        });
    }
    
    const token = authHeader.split(' ')[1];
    
    try {
        console.log('üìã Pobieranie serwer√≥w u≈ºytkownika...');
        
        // Pobierz serwery u≈ºytkownika z Discord API
        const response = await axios.get(
            'https://discord.com/api/users/@me/guilds',
            {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            }
        );
        
        const userGuilds = response.data;
        const botGuildIds = client.guilds.cache.map(g => g.id);
        
        // Filtruj tylko serwery gdzie:
        // 1. Bot jest obecny
        // 2. U≈ºytkownik ma uprawnienia administratora
        const filteredGuilds = userGuilds.filter(guild => {
            const isAdmin = (guild.permissions & 0x8) === 0x8;
            const botPresent = botGuildIds.includes(guild.id);
            return isAdmin && botPresent;
        });
        
        console.log(`‚úÖ Znaleziono ${filteredGuilds.length} dostƒôpnych serwer√≥w`);
        
        res.json(filteredGuilds);
        
    } catch (error) {
        console.error('‚ùå B≈ÇƒÖd pobierania serwer√≥w:', error.response?.data || error.message);
        res.status(500).json({ 
            error: 'B≈ÇƒÖd pobierania serwer√≥w',
            details: error.response?.data || error.message
        });
    }
});

// ============================================
// Pobierz kana≈Çy serwera
// ============================================
app.get('/guilds/:guildId/channels', async (req, res) => {
    const { guildId } = req.params;
    const authHeader = req.headers.authorization;
    
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
        return res.status(401).json({ 
            error: 'Brak tokenu autoryzacyjnego' 
        });
    }
    
    try {
        console.log(`üìã Pobieranie kana≈Ç√≥w dla serwera ${guildId}...`);
        
        const guild = client.guilds.cache.get(guildId);
        
        if (!guild) {
            return res.status(404).json({ 
                error: 'Bot nie jest na tym serwerze',
                hint: 'Upewnij siƒô, ≈ºe bot zosta≈Ç dodany do tego serwera'
            });
        }
        
        // Pobierz tylko kana≈Çy tekstowe
        const textChannels = guild.channels.cache
            .filter(channel => channel.type === ChannelType.GuildText)
            .map(channel => ({
                id: channel.id,
                name: channel.name,
                type: channel.type,
                position: channel.position
            }))
            .sort((a, b) => a.position - b.position);
        
        console.log(`‚úÖ Znaleziono ${textChannels.length} kana≈Ç√≥w tekstowych`);
        
        res.json(textChannels);
        
    } catch (error) {
        console.error('‚ùå B≈ÇƒÖd pobierania kana≈Ç√≥w:', error.message);
        res.status(500).json({ 
            error: 'B≈ÇƒÖd pobierania kana≈Ç√≥w',
            details: error.message
        });
    }
});

// ============================================
// Wy≈õlij embed na kana≈Ç
// ============================================
app.post('/send-embed', async (req, res) => {
    const { channelId, embed } = req.body;
    const authHeader = req.headers.authorization;
    
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
        return res.status(401).json({ 
            error: 'Brak tokenu autoryzacyjnego' 
        });
    }
    
    if (!channelId || !embed) {
        return res.status(400).json({ 
            error: 'Brak wymaganych danych (channelId, embed)' 
        });
    }
    
    try {
        console.log(`üì§ Wysy≈Çanie embeda na kana≈Ç ${channelId}...`);
        
        // Pobierz kana≈Ç
        const channel = client.channels.cache.get(channelId);
        
        if (!channel) {
            return res.status(404).json({ 
                error: 'Kana≈Ç nie znaleziony',
                hint: 'Upewnij siƒô, ≈ºe bot ma dostƒôp do tego kana≈Çu'
            });
        }
        
        // Sprawd≈∫ uprawnienia bota
        if (!channel.permissionsFor(client.user).has(['SendMessages', 'EmbedLinks'])) {
            return res.status(403).json({ 
                error: 'Bot nie ma uprawnie≈Ñ do wysy≈Çania wiadomo≈õci lub embed√≥w na tym kanale'
            });
        }
        
        // Zweryfikuj u≈ºytkownika
        const token = authHeader.split(' ')[1];
        const userResponse = await axios.get(
            'https://discord.com/api/users/@me/guilds',
            {
                headers: { 'Authorization': `Bearer ${token}` }
            }
        );
        
        const hasAccess = userResponse.data.some(guild => guild.id === channel.guild.id);
        
        if (!hasAccess) {
            return res.status(403).json({ 
                error: 'Nie masz dostƒôpu do tego serwera' 
            });
        }
        
        // Stw√≥rz Discord embed
        const discordEmbed = new EmbedBuilder()
            .setColor(embed.color || 0x9b59b6)
            .setTimestamp();
        
        if (embed.title) discordEmbed.setTitle(embed.title);
        if (embed.description) discordEmbed.setDescription(embed.description);
        if (embed.thumbnail?.url) discordEmbed.setThumbnail(embed.thumbnail.url);
        if (embed.image?.url) discordEmbed.setImage(embed.image.url);
        
        if (embed.author?.name) {
            discordEmbed.setAuthor({
                name: embed.author.name,
                iconURL: embed.author.icon_url
            });
        }
        
        if (embed.footer?.text) {
            discordEmbed.setFooter({
                text: embed.footer.text,
                iconURL: embed.footer.icon_url
            });
        }
        
        // Wy≈õlij embed
        await channel.send({ embeds: [discordEmbed] });
        
        console.log(`‚úÖ Embed wys≈Çany pomy≈õlnie na kana≈Ç #${channel.name}`);
        
        res.json({ 
            success: true, 
            message: 'Embed wys≈Çany pomy≈õlnie!',
            channel: {
                id: channel.id,
                name: channel.name
            }
        });
        
    } catch (error) {
        console.error('‚ùå B≈ÇƒÖd wysy≈Çania embeda:', error.message);
        res.status(500).json({ 
            error: 'B≈ÇƒÖd wysy≈Çania embeda',
            details: error.message
        });
    }
});

// ============================================
// Error handling
// ============================================
app.use((err, req, res, next) => {
    console.error('‚ùå Nieobs≈Çu≈ºony b≈ÇƒÖd:', err);
    res.status(500).json({ 
        error: 'Wewnƒôtrzny b≈ÇƒÖd serwera',
        details: err.message
    });
});

// ============================================
// START SERWERA
// ============================================

// Najpierw zaloguj bota
client.login(process.env.BOT_TOKEN)
    .then(() => {
        // Nastƒôpnie uruchom serwer HTTP
        app.listen(PORT, () => {
            console.log('================================');
            console.log(`üöÄ Serwer API uruchomiony!`);
            console.log(`üì° Port: ${PORT}`);
            console.log(`üåê URL: http://localhost:${PORT}`);
            console.log('================================');
        });
    })
    .catch(error => {
        console.error('‚ùå B≈ÇƒÖd logowania bota:', error);
        process.exit(1);
    });

// Obs≈Çuga zamykania
process.on('SIGINT', () => {
    console.log('\nüëã Zamykanie bota...');
    client.destroy();
    process.exit(0);
});
